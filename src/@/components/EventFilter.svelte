<script lang="ts">
  import { equals } from "@/utils/set";

  export let allUsers: string[] = [];
  let allSet: Set<string> = new Set(allUsers);
  $: allUsers = [...allSet];
  $: allUsers && allUsersToSet();
  function allUsersToSet() {
    const newSet = new Set(allUsers);
    if (equals(newSet, allSet)) return;
    allSet = newSet;
  }

  export let selectedUsers: string[] = [];
  let selectedSet: Set<string> = new Set(...selectedUsers);
  $: selectedUsers = [...selectedSet];
  $: selectedUsers && selectedUsersToSet();
  function selectedUsersToSet() {
    const newSet = new Set(selectedUsers);
    if (equals(newSet, selectedSet)) return;
    selectedSet = newSet;
  }

  function toggle(user: string) {
    if (selectedSet.has(user)) {
      selectedSet.delete(user);
    } else {
      selectedSet.add(user);
    }
    focusedIndex = allUsers.indexOf(user);
    selectedSet = selectedSet;
  }

  let focusedIndex = -1;

  function focus() {
    if (focusedIndex !== -1) return;
    focusedIndex = 0;
  }

  function blur() {
    focusedIndex = -1;
  }

  function keydown(event: KeyboardEvent) {
    const { key } = event;
    if (Object.keys(actions).includes(key)) {
      actions[key]();
      event.preventDefault();
    }
  }

  const actions = {
    ArrowUp: () => {
      if (focusedIndex > 0) focusedIndex--;
    },
    ArrowDown: () => {
      if (focusedIndex < allUsers.length - 1) focusedIndex++;
    },
    get ArrowRight() {
      return this["ArrowDown"];
    },
    get ArrowLeft() {
      return this["ArrowUp"];
    },
    " ": () => {
      toggle(allUsers[focusedIndex]);
    },
    get Enter() {
      return this[" "];
    },
  };
</script>

<div class="p-4 bg-white card">
  <div
    tabindex="0"
    on:focus="{focus}"
    on:blur="{blur}"
    on:keydown="{keydown}"
  ></div>
  <h2>Find someone</h2>
  {#if allUsers.length === 0}
    <span class="text-xs"> Nobody's here yet... </span>
  {:else}
    <div class="flex flex-wrap items-center space-x-2 text-xs cursor-pointer">
      {#each allUsers as user, i}
        <div
          on:click="{() => toggle(user)}"
          class="{`
            p-2 mt-2 bg-gray-100 rounded-full
            ${
              selectedSet.has(user)
                ? `
              bg-primary text-white
              hover:bg-primary-lighter shadow-md-primary
              active:bg-primary-darker active:text-white
              `
                : `
              hover:bg-gray-50 hover:shadow-md
              active:bg-gray-200
            `
            }
            ${focusedIndex === i ? 'ring ring-primary' : ''}
          `.replace(/\s\s+/g, ' ')}"
        >
          {user}
        </div>
      {/each}
    </div>
  {/if}
</div>
