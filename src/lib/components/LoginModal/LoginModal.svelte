<script lang="ts">
  import { fade, fly, slide } from 'svelte/transition';
  import { clickOutside } from '$lib/utils/use-click-outside';
  import Textfield from '$lib/components/Textfield.svelte';
  import { login } from '$lib/gql/login';
  import { signup } from '$lib/gql/signup';
  import { getAuthModalState } from './state';
  import Header from './Header.svelte';
  import Tooltip from './Tooltip.svelte';
  import type { APIError } from '$lib/typings/error';
  import { session } from '$app/stores';
  import { showAuth } from '$lib/app-state';

  const { name, email, password, resetErrors } = getAuthModalState();

  const confirm = async () => {
    if (loggingIn) {
      await handleLogin();
    } else {
      await handleSignup();
    }
  };

  const handleLogin = async () => {
    try {
      $session.user = await login({ email: $email.value, password: $password.value });
      dismiss();
    } catch (errors) {
      (errors as APIError[]).forEach(handleAPIError);
    }
  };

  const handleSignup = async () => {
    try {
      $session.user = await signup({
        name: $name.value,
        email: $email.value,
        password: $password.value,
      });
      dismiss();
    } catch (errors) {
      (errors as APIError[]).forEach(handleAPIError);
    }
  };

  const handleAPIError = (error: APIError) => {
    const { id } = error.extensions.exception.details;
    console.error({ id, message: error.message });
    if (id === 'auth/user-not-found') {
      $email.error = 'User not found';
    } else if (id === 'auth/missing-email') {
      $email.error = 'Required';
    } else if (id === 'auth/email-already-exists') {
      $email.error = 'Email already taken';
    } else if (id === 'auth/invalid-email') {
      $email.error = 'Badly formatted email';
    } else if (id === 'auth/wrong-password') {
      $password.error = 'Wrong password';
    } else if (id === 'auth/invalid-password') {
      $password.error = 'Password must be at least 6 characters long';
    }
  };

  const dismiss = () => {
    $showAuth = false;
  };

  let loggingIn = true;
  $: {
    loggingIn;
    resetErrors();
  }
  let hovering = false;
  let transitioning = false;
</script>

{#if $showAuth}
  <div
    transition:fade={{ duration: 200 }}
    class="fixed inset-0 flex items-center justify-center bg-gray-500 bg-opacity-50"
  >
    <form
      in:fly|local={{ y: 200 }}
      on:introstart={() => (transitioning = true)}
      on:introend={() => (transitioning = false)}
      on:submit|preventDefault={confirm}
      use:clickOutside={dismiss}
      class="p-4 m-4 space-y-4 card"
    >
      <Header bind:loggingIn />
      {#if !loggingIn}
        <div transition:slide={{ duration: 200 }}>
          <Textfield
            bind:value={$name.value}
            error={$name.error}
            placeholder="Name"
            required
            class="block"
          />
        </div>
      {/if}
      <Textfield
        bind:value={$email.value}
        error={$email.error}
        placeholder="Email"
        required
        focusOnMount
        class="block"
      />
      <Textfield
        bind:value={$password.value}
        error={$password.error}
        placeholder="Password"
        required
        password
        class="block"
      />
      <div class="flex space-x-4">
        <button type="button" on:click={dismiss} class="w-full p-3 rounded-full button shade">
          Cancel
        </button>
        <button type="submit" class="w-full p-3 rounded-full button primary"> Confirm </button>
      </div>
      <Tooltip bind:hovering {transitioning} />
    </form>
  </div>
{/if}
